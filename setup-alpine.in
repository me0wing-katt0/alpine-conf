#!/bin/sh

PROGRAM=setup-alpine
VERSION=@VERSION@

PREFIX=
. $PREFIX/lib/libalpine.sh

is_qemu() {
	grep -q "QEMU" /proc/cpuinfo \
		|| strings /sys/firmware/dmi/tables/DMI 2>/dev/null | grep -q QEMU
}

shift $(expr $OPTIND - 1)

rc_sys=$(openrc --sys)

# mount xenfs so we can detect xen dom0
if [ "$rc_sys" = "XENU" ] && ! grep -q '^xenfs' /proc/mounts; then
	modprobe xenfs
	mount -t xenfs xenfs /proc/xen
fi

PKGADD="apk add"

if [ "$rc_sys" != LXC ]; then
	$PREFIX/sbin/setup-keymap
	$PREFIX/sbin/setup-hostname
fi


$PREFIX/sbin/setup-interfaces -a -r

# setup up dns if no dhcp was configured
grep '^iface.*dhcp' $ROOT/etc/network/interfaces > /dev/null ||\
	$PREFIX/sbin/setup-dns ${DNSOPTS}

# set root password
if [ -z "$NOCOMMIT" ] && [ -z "$empty_root_password" ]; then
	while ! passwd ; do
		echo "Please retry."
	done
fi

$PREFIX/sbin/setup-timezone ${TIMEZONEOPTS}

rc-update --quiet add networking boot
rc-update --quiet add urandom boot
for svc in acpid cron crond; do
	if rc-service --exists $svc; then
		rc-update --quiet add $svc
	fi
done

# enable new hostname
rc-service hostname --quiet restart

# start up the services
openrc boot
openrc default

_dn=$(sed -n \
-e '/^domain[[:space:]][[:space:]]*/{s///;s/\([^[:space:]]*\).*$/\1/;h;}' \
-e '/^search[[:space:]][[:space:]]*/{s///;s/\([^[:space:]]*\).*$/\1/;h;}' \
-e '${g;p;}' /etc/resolv.conf 2>/dev/null)

_hn=$(hostname)
_hn=${_hn%%.*}

wget https://raw.githubusercontent.com/StevenBlack/hosts/master/alternates/fakenews-gambling-porn-social/hosts -O /etc/hosts

# activate the proxy if configured
if [ -r "$ROOT/etc/profile" ]; then
	. "$ROOT/etc/profile"
fi

if ! is_qemu && [ "$rc_sys" != "LXC" ]; then
	$PREFIX/sbin/setup-ntp -c busybox
fi

$PREFIX/sbin/setup-apkrepos -c -1

$PREFIX/sbin/setup-sshd

if is_xen_dom0; then
	setup-xen-dom0
fi

if [ "$rc_sys" = "LXC" ]; then
	exit 0
fi

DEFAULT_DISK=sda \
	$PREFIX/sbin/setup-disk -q -m sys || exit
